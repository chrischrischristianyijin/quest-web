<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Relogin Test - Quest</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .credentials-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Auto Relogin Test Tool</h1>
            <p>Test automatic relogin functionality when token expires</p>
        </div>

        <div class="test-section">
            <h3>üìä Current Status</h3>
            <div id="currentStatus" class="status info">Click "Check Status" to get current information</div>
            <button onclick="checkCurrentStatus()">Check Status</button>
        </div>

        <div class="test-section">
            <h3>üíæ Save Test Credentials</h3>
            <div class="credentials-form">
                <div class="form-group">
                    <label for="testEmail">Test Email:</label>
                    <input type="email" id="testEmail" placeholder="Enter test email">
                </div>
                <div class="form-group">
                    <label for="testPassword">Test Password:</label>
                    <input type="password" id="testPassword" placeholder="Enter test password">
                </div>
            </div>
            <button onclick="saveTestCredentials()">Save Test Credentials</button>
            <button onclick="clearTestCredentials()">Clear Test Credentials</button>
            <div id="credentialsStatus" class="status info">Waiting for operation...</div>
        </div>

        <div class="test-section">
            <h3>üß™ Simulate Token Expiry</h3>
            <div id="simulationStatus" class="status info">Click "Simulate Token Expiry" to start testing</div>
            <button onclick="simulateTokenExpiry()">Simulate Token Expiry</button>
            <button onclick="simulateAPIError()">Simulate API 401 Error</button>
        </div>

        <div class="test-section">
            <h3>‚öôÔ∏è Control Settings</h3>
            <div id="controlStatus" class="status info">Current settings status</div>
            <button onclick="enableAutoRelogin()">Enable Auto Relogin</button>
            <button onclick="disableAutoRelogin()">Disable Auto Relogin</button>
            <button onclick="resetAttempts()">Reset Attempts</button>
        </div>

        <div class="test-section">
            <h3>üìù Test Log</h3>
            <div id="testLog" class="code-block">Waiting for test logs...</div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script type="module">
        import { autoReloginManager } from '/js/auto-relogin.js';
        import { auth } from '/js/auth.js';

        let testLog = [];

        // Ê∑ªÂä†Êó•Âøó
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${message}`);
            updateLogDisplay();
        }

        // Êõ¥Êñ∞Êó•ÂøóÊòæÁ§∫
        function updateLogDisplay() {
            const logDiv = document.getElementById('testLog');
            logDiv.textContent = testLog.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Ê£ÄÊü•ÂΩìÂâçÁä∂ÊÄÅ
        window.checkCurrentStatus = () => {
            const status = autoReloginManager.getStatus();
            const authStatus = auth.checkAuth();
            const hasCredentials = autoReloginManager.getSavedCredentials();
            
            const statusDiv = document.getElementById('currentStatus');
            statusDiv.className = 'status info';
            statusDiv.innerHTML = `
                <strong>üìä Current Status</strong><br>
                <div class="code-block">${JSON.stringify({
                    autoRelogin: status,
                    auth: {
                        isAuthenticated: authStatus,
                        hasToken: !!auth.getCurrentToken()
                    },
                    credentials: {
                        hasSaved: !!hasCredentials,
                        email: hasCredentials?.email || 'None'
                    }
                }, null, 2)}</div>
            `;
            
            addLog('‚úÖ Status check completed');
        };

        // ‰øùÂ≠òÊµãËØïÂá≠ÊçÆ
        window.saveTestCredentials = () => {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            if (!email || !password) {
                const statusDiv = document.getElementById('credentialsStatus');
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå Please enter email and password';
                return;
            }
            
            const success = autoReloginManager.saveCredentials(email, password);
            const statusDiv = document.getElementById('credentialsStatus');
            
            if (success) {
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '‚úÖ Test credentials saved';
                addLog(`üíæ Saved test credentials: ${email}`);
            } else {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå Failed to save credentials';
                addLog('‚ùå Failed to save credentials');
            }
        };

        // Clear test credentials
        window.clearTestCredentials = () => {
            autoReloginManager.clearSavedCredentials();
            const statusDiv = document.getElementById('credentialsStatus');
            statusDiv.className = 'status warning';
            statusDiv.innerHTML = 'üóëÔ∏è Test credentials cleared';
            addLog('üóëÔ∏è Cleared test credentials');
        };

        // Simulate token expiry
        window.simulateTokenExpiry = () => {
            addLog('üß™ Simulating token expiry event...');
            
            // Trigger auth expired event
            window.dispatchEvent(new CustomEvent('quest-auth-expired', {
                detail: {
                    status: 401,
                    reason: 'Token expired (simulated)',
                    error: 'Simulated token expiry for testing'
                }
            }));
            
            const statusDiv = document.getElementById('simulationStatus');
            statusDiv.className = 'status warning';
            statusDiv.innerHTML = 'üß™ Token expiry event triggered, observe auto relogin behavior';
        };

        // Simulate API error
        window.simulateAPIError = () => {
            addLog('üß™ Simulating API 401 error...');
            
            // Trigger API error event
            window.dispatchEvent(new CustomEvent('quest-api-error', {
                detail: {
                    status: 401,
                    reason: 'API authentication failed (simulated)',
                    error: 'Simulated API error for testing'
                }
            }));
            
            const statusDiv = document.getElementById('simulationStatus');
            statusDiv.className = 'status warning';
            statusDiv.innerHTML = 'üß™ API 401 error triggered, observe auto relogin behavior';
        };

        // Enable auto relogin
        window.enableAutoRelogin = () => {
            autoReloginManager.setEnabled(true);
            const statusDiv = document.getElementById('controlStatus');
            statusDiv.className = 'status success';
            statusDiv.innerHTML = '‚úÖ Auto relogin enabled';
            addLog('‚úÖ Auto relogin enabled');
        };

        // Disable auto relogin
        window.disableAutoRelogin = () => {
            autoReloginManager.setEnabled(false);
            const statusDiv = document.getElementById('controlStatus');
            statusDiv.className = 'status warning';
            statusDiv.innerHTML = '‚ö†Ô∏è Auto relogin disabled';
            addLog('‚ö†Ô∏è Auto relogin disabled');
        };

        // Reset retry attempts
        window.resetAttempts = () => {
            autoReloginManager.resetAttempts();
            const statusDiv = document.getElementById('controlStatus');
            statusDiv.className = 'status info';
            statusDiv.innerHTML = 'üîÑ Retry attempts reset';
            addLog('üîÑ Retry attempts reset');
        };

        // Clear log
        window.clearLog = () => {
            testLog = [];
            updateLogDisplay();
        };

        // Listen to auto relogin events
        window.addEventListener('quest-relogin-success', (event) => {
            addLog(`‚úÖ Auto relogin successful: ${JSON.stringify(event.detail)}`);
        });

        window.addEventListener('quest-relogin-failure', (event) => {
            addLog(`‚ùå Auto relogin failed: ${JSON.stringify(event.detail)}`);
        });

        window.addEventListener('quest-app-refresh', (event) => {
            addLog(`üîÑ App refresh: ${JSON.stringify(event.detail)}`);
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üöÄ Auto relogin test tool loaded');
            addLog('üí° Usage instructions:');
            addLog('  1. First save test credentials');
            addLog('  2. Simulate token expiry or API error');
            addLog('  3. Observe auto relogin behavior');
            addLog('  4. Check test logs for detailed process');
            
            // Auto check status
            setTimeout(() => {
                checkCurrentStatus();
            }, 1000);
        });
    </script>
</body>
</html>
