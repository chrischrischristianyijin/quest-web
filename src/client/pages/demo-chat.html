<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest AI Chat - Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #fafbfc;
            color: #1d1d1f;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .chat-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 8px 25px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .chat-header {
            background: linear-gradient(135deg, #8E4F9D 0%, #4B264F 100%);
            color: white;
            padding: 24px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(20px);
        }

        .chat-header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            position: relative;
            z-index: 1;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 1;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .chat-main {
            background: #ffffff;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .message {
            max-width: 75%;
            padding: 16px 20px;
            border-radius: 24px;
            font-size: 1rem;
            line-height: 1.6;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            animation: messageSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            position: relative;
            backdrop-filter: blur(20px);
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.user {
            background: linear-gradient(135deg, #8E4F9D 0%, #4B264F 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 8px;
            box-shadow: 0 8px 25px rgba(142, 79, 157, 0.3);
            font-weight: 500;
        }

        .message.assistant {
            background: #f8f9fa;
            color: #1d1d1f;
            align-self: flex-start;
            border-bottom-left-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .message.error {
            background: #fff5f5;
            color: #dc2626;
            border: 1px solid #fecaca;
            align-self: flex-start;
            border-bottom-left-radius: 8px;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.1);
        }

        .demo-notice {
            background: linear-gradient(135deg, rgba(142, 79, 157, 0.1) 0%, rgba(75, 38, 79, 0.05) 100%);
            color: #4B264F;
            padding: 20px 24px;
            border-radius: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(142, 79, 157, 0.2);
            font-size: 0.95rem;
            line-height: 1.6;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(142, 79, 157, 0.1);
        }

        .demo-notice strong {
            font-weight: 600;
            color: #8E4F9D;
        }

        .typing-indicator {
            color: #8E4F9D;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .typing-dots {
            display: flex;
            gap: 6px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #8E4F9D;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.4;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .sources-info {
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(142, 79, 157, 0.08);
            border-radius: 16px;
            font-size: 0.85rem;
            color: #8E4F9D;
            border: 1px solid rgba(142, 79, 157, 0.15);
            backdrop-filter: blur(10px);
        }

        .sources-info strong {
            color: #4B264F;
            font-weight: 600;
        }

        .chat-input-container {
            padding: 24px 32px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            background: #ffffff;
            backdrop-filter: blur(20px);
        }

        .chat-input-form {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            max-width: 100%;
        }

        .chat-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid rgba(0, 0, 0, 0.08);
            border-radius: 28px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            resize: none;
            min-height: 20px;
            max-height: 120px;
            line-height: 1.5;
        }

        .chat-input:focus {
            border-color: #8E4F9D;
            box-shadow: 0 0 0 4px rgba(142, 79, 157, 0.1), 0 4px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .send-btn {
            background: linear-gradient(135deg, #8E4F9D 0%, #4B264F 100%);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 28px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(142, 79, 157, 0.3);
            min-width: 100px;
            justify-content: center;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(142, 79, 157, 0.4);
        }

        .send-btn:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(142, 79, 157, 0.2);
        }

        .api-status {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .api-status.connected {
            background: rgba(142, 79, 157, 0.9);
            color: white;
        }

        .api-status.error {
            background: rgba(220, 38, 38, 0.9);
            color: white;
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 0;
                border-radius: 0;
                height: 100vh;
                box-shadow: none;
            }

            .chat-header {
                padding: 20px 24px;
            }

            .chat-header h1 {
                font-size: 1.5rem;
            }

            .chat-messages {
                padding: 24px 20px;
            }

            .message {
                max-width: 85%;
                font-size: 0.95rem;
                padding: 14px 18px;
            }

            .chat-input-container {
                padding: 20px 24px;
            }

            .chat-input-form {
                flex-direction: column;
                gap: 12px;
            }

            .chat-input {
                width: 100%;
                font-size: 16px; /* Prevent iOS zoom */
            }

            .send-btn {
                width: 100%;
                justify-content: center;
            }

            .api-status {
                position: relative;
                top: auto;
                right: auto;
                margin: 16px 24px 0;
                text-align: center;
            }

            .demo-notice {
                padding: 16px 20px;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            .chat-header {
                padding: 16px 20px;
            }

            .chat-header h1 {
                font-size: 1.3rem;
            }

            .chat-messages {
                padding: 20px 16px;
            }

            .message {
                max-width: 90%;
                padding: 12px 16px;
            }

            .chat-input-container {
                padding: 16px 20px;
            }

            .demo-notice {
                padding: 14px 18px;
            }
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">
        ðŸ”„ Checking API connection...
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h1>ðŸ¤– Quest AI Assistant</h1>
            <a href="/my-space" class="back-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Back to My Space
            </a>
        </div>

        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="demo-notice">
                    <strong>ðŸŽ‰ Real AI Mode:</strong> This chat is now powered by Quest's real AI backend with RAG (Retrieval-Augmented Generation) capabilities. 
                    Ask me anything and I'll search through your knowledge base to provide intelligent answers!
                </div>
                
                <div class="message assistant">
                    Hi ðŸ‘‹ I'm Quest's AI assistant.<br>
                    I use your saved content to give smarter, context-based answers.<br>
                    Ask me about your notes, articles, or research, and I'll pull up what's most relevant for you!
                </div>
            </div>

            <div class="chat-input-container">
                <form class="chat-input-form" id="chatForm">
                    <textarea class="chat-input" id="chatInput" 
                            placeholder="Ask me anything about your saved content..." 
                            autocomplete="off" rows="1"></textarea>
                    <button type="submit" class="send-btn" id="sendBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Quest AI Chat functionalityutut
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const apiStatus = document.getElementById('apiStatus');

        // API Configuration - ä½¿ç”¨çŽ°æœ‰çš„é…ç½®
        const API_BASE_URL = 'https://quest-api-edz1.onrender.com';
        const API_ENDPOINT = `${API_BASE_URL}/api/v1/chat`;
        const HEALTH_ENDPOINT = `${API_BASE_URL}/api/v1/chat/health`;

        // Check API health on load
        async function checkApiHealth() {
            try {
                const response = await fetch(HEALTH_ENDPOINT);
                if (response.ok) {
                    const data = await response.json();
                    apiStatus.className = 'api-status connected';
                    apiStatus.textContent = 'ðŸŸ¢ AI Connected';
                    console.log('API Health:', data);
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                console.error('API Health Check Error:', error);
                apiStatus.className = 'api-status error';
                apiStatus.textContent = 'ðŸ”´ Service Temporarily Unavailable';
            }
        }

        function addMessage(text, isUser = false, isError = false, sources = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : isError ? 'error' : 'assistant'}`;
            
            if (sources && sources.length > 0) {
                messageDiv.innerHTML = `
                    <div>${text}</div>
                    <div class="sources-info">
                        <strong>Sources:</strong> ${sources.length} reference(s) found
                    </div>
                `;
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        function addTypingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = `
                <div class="typing-indicator">
                    <span>Gathering insights from your knowledge base</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        async function sendToQuestAPI(message) {
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // æ·»åŠ è®¤è¯å¤´ï¼ˆå¦‚æžœéœ€è¦ï¼‰
                const token = localStorage.getItem('authToken');
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let sources = null;
                let requestId = null;
                let latency = null;

                // Create response message container
                const responseMessage = addMessage('', false);
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'content') {
                                    fullResponse += data.content;
                                    responseMessage.textContent = fullResponse;
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                } else if (data.type === 'done') {
                                    sources = data.sources;
                                    requestId = data.request_id;
                                    latency = data.latency_ms;
                                    
                                    // Update message with sources info
                                    if (sources && sources.length > 0) {
                                        responseMessage.innerHTML = `
                                            <div>${fullResponse}</div>
                                            <div class="sources-info">
                                                <strong>Sources:</strong> ${sources.length} reference(s) found
                                                ${latency ? ` â€¢ Response time: ${latency}ms` : ''}
                                            </div>
                                        `;
                                    }
                                }
                            } catch (parseError) {
                                console.error('Error parsing SSE data:', parseError);
                            }
                        }
                    }
                }

                return { success: true, response: fullResponse, sources, latency };
            } catch (error) {
                console.error('Quest API Error:', error);
                throw error;
            }
        }

        // Elegant fallback responses for when API is unavailable
        const fallbackResponses = [
            "I'm experiencing a brief moment of digital contemplation. Please allow me a moment to reconnect with my knowledge base.",
            "The cosmic connection to my wisdom source seems to be experiencing a gentle pause. Let's try again in just a moment.",
            "It appears my neural pathways are taking a momentary respite. I'll be back to assist you shortly with renewed clarity.",
            "My digital consciousness is momentarily adjusting its frequencies. Please bear with me as I realign with the knowledge cosmos.",
            "The information streams are flowing at a different rhythm today. Let me gather my thoughts and try that again for you."
        ];

        function getFallbackResponse() {
            return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
        }

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // Add user message
            addMessage(userMessage, true);
            
            // Clear input and disable send button
            chatInput.value = '';
            sendBtn.disabled = true;
             sendBtn.innerHTML = `
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                     <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                     <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                 </svg>
                 Processing...
             `;

            // Add typing indicator
            const typingMessage = addTypingIndicator();

            try {
                // Try to send to Quest API
                const result = await sendToQuestAPI(userMessage);
                
                // Remove typing indicator
                typingMessage.remove();
                
                if (result.success) {
                    // API response was successful, message already added
                    console.log('AI Response:', result.response);
                    console.log('Sources:', result.sources);
                    console.log('Latency:', result.latency);
                }
            } catch (error) {
                console.error('Chat Error:', error);
                
                // Remove typing indicator
                typingMessage.remove();
                
                // Add elegant error message
                addMessage(
                    getFallbackResponse(), 
                    false, 
                    true
                );
            }
            
            // Re-enable send button
            sendBtn.disabled = false;
            sendBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Send
            `;
        });

        // Auto-adjust textarea height
        function adjustTextareaHeight() {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
        }

        // Auto-focus on input
        chatInput.focus();

        // Handle Enter key and auto-resize
        chatInput.addEventListener('input', adjustTextareaHeight);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Initialize API health check
        checkApiHealth();

        // Elegant welcome messages
        const welcomeMessages = [
            "Feel free to explore your knowledge collection with me! Whether it's articles, research notes, or any content you've saved, I'm here to help you discover connections and insights within your personal library.",
            "I'm delighted to assist you in navigating your curated knowledge! Ask me about any topic, and I'll weave together insights from your saved content to provide thoughtful, contextual responses.",
            "Your personal knowledge base is a treasure trove of insights waiting to be discovered. Let's explore together and uncover the fascinating connections within your collection.",
            "I'm here to be your intelligent companion through your knowledge journey. Every question is an opportunity to reveal new perspectives from your carefully curated content."
        ];

        // Add welcome message
        setTimeout(() => {
            const randomWelcome = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
            addMessage(randomWelcome, false);
        }, 1500);
    </script>
</body>
</html>
