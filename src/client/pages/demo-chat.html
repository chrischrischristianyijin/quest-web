<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest AI Chat - Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #4B264F 0%, #8E4F9D 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .chat-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .chat-main {
            background: white;
            border-radius: 0 0 16px 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            opacity: 0;
            transform: translateY(10px);
            animation: messageSlideIn 0.3s ease-out forwards;
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, #4B264F 0%, #8E4F9D 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: #f1f3f4;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .demo-notice {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
            font-size: 0.9rem;
        }

        .demo-notice strong {
            font-weight: 600;
        }

        .typing-indicator {
            color: #666;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .sources-info {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(75, 38, 79, 0.1);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #666;
        }

        .sources-info strong {
            color: #4B264F;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .chat-input-form {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #4B264F;
        }

        .send-btn {
            background: linear-gradient(135deg, #4B264F 0%, #8E4F9D 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 24px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(75, 38, 79, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
        }

        .api-status.connected {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .api-status.error {
            background: #ffebee;
            color: #c62828;
        }

        @media (max-width: 768px) {
            .chat-container {
                padding: 10px;
                height: 100vh;
            }

            .chat-header {
                padding: 15px 20px;
            }

            .chat-header h1 {
                font-size: 1.3rem;
            }

            .message {
                max-width: 85%;
                font-size: 0.9rem;
            }

            .chat-input-form {
                flex-direction: column;
                gap: 10px;
            }

            .chat-input {
                width: 100%;
            }

            .send-btn {
                width: 100%;
                justify-content: center;
            }

            .api-status {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px 0;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">
        ðŸ”„ Checking API connection...
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h1>ðŸ¤– Quest AI Chat</h1>
            <a href="/my-space" class="back-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Back to My Space
            </a>
        </div>

        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="demo-notice">
                    <strong>ðŸŽ‰ Real AI Mode:</strong> This chat is now powered by Quest's real AI backend with RAG (Retrieval-Augmented Generation) capabilities. 
                    Ask me anything and I'll search through your knowledge base to provide intelligent answers!
                </div>
                
                <div class="message assistant">
                    ðŸ‘‹ Hello! I'm Quest's AI assistant powered by real AI technology. 
                    I can help you explore and understand your saved content using advanced RAG capabilities. 
                    What would you like to know about your knowledge collection?
                </div>
            </div>

            <div class="chat-input-container">
                <form class="chat-input-form" id="chatForm">
                    <input type="text" class="chat-input" id="chatInput" 
                           placeholder="Ask me anything about your saved content..." 
                           autocomplete="off">
                    <button type="submit" class="send-btn" id="sendBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Quest AI Chat functionalityutut
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const apiStatus = document.getElementById('apiStatus');

        // API Configuration - ä½¿ç”¨çŽ°æœ‰çš„é…ç½®
        const API_BASE_URL = 'https://quest-api-edz1.onrender.com';
        const API_ENDPOINT = `${API_BASE_URL}/api/v1/chat`;
        const HEALTH_ENDPOINT = `${API_BASE_URL}/api/v1/chat/health`;

        // Check API health on load
        async function checkApiHealth() {
            try {
                const response = await fetch(HEALTH_ENDPOINT);
                if (response.ok) {
                    const data = await response.json();
                    apiStatus.className = 'api-status connected';
                    apiStatus.textContent = 'ðŸŸ¢ AI Connected';
                    console.log('API Health:', data);
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                console.error('API Health Check Error:', error);
                apiStatus.className = 'api-status error';
                apiStatus.textContent = 'ðŸ”´ API Error - Using Fallback';
            }
        }

        function addMessage(text, isUser = false, isError = false, sources = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : isError ? 'error' : 'assistant'}`;
            
            if (sources && sources.length > 0) {
                messageDiv.innerHTML = `
                    <div>${text}</div>
                    <div class="sources-info">
                        <strong>Sources:</strong> ${sources.length} reference(s) found
                    </div>
                `;
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        function addTypingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = `
                <div class="typing-indicator">
                    <span>AI is thinking</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        async function sendToQuestAPI(message) {
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // æ·»åŠ è®¤è¯å¤´ï¼ˆå¦‚æžœéœ€è¦ï¼‰
                const token = localStorage.getItem('authToken');
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let sources = null;
                let requestId = null;
                let latency = null;

                // Create response message container
                const responseMessage = addMessage('', false);
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'content') {
                                    fullResponse += data.content;
                                    responseMessage.textContent = fullResponse;
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                } else if (data.type === 'done') {
                                    sources = data.sources;
                                    requestId = data.request_id;
                                    latency = data.latency_ms;
                                    
                                    // Update message with sources info
                                    if (sources && sources.length > 0) {
                                        responseMessage.innerHTML = `
                                            <div>${fullResponse}</div>
                                            <div class="sources-info">
                                                <strong>Sources:</strong> ${sources.length} reference(s) found
                                                ${latency ? ` â€¢ Response time: ${latency}ms` : ''}
                                            </div>
                                        `;
                                    }
                                }
                            } catch (parseError) {
                                console.error('Error parsing SSE data:', parseError);
                            }
                        }
                    }
                }

                return { success: true, response: fullResponse, sources, latency };
            } catch (error) {
                console.error('Quest API Error:', error);
                throw error;
            }
        }

        // Fallback responses for when API is unavailable
        const fallbackResponses = [
            "I'm currently experiencing some technical difficulties with the AI service. Please try again in a moment, or check back later.",
            "The AI backend is temporarily unavailable. I'm working on getting it back online as soon as possible.",
            "Sorry, I'm having trouble connecting to the AI service right now. Please try your question again in a few moments.",
            "The Quest AI service is currently offline for maintenance. Please try again later.",
            "I'm unable to process your request at the moment due to a service interruption. Please try again soon."
        ];

        function getFallbackResponse() {
            return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
        }

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // Add user message
            addMessage(userMessage, true);
            
            // Clear input and disable send button
            chatInput.value = '';
            sendBtn.disabled = true;
            sendBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Thinking...
            `;

            // Add typing indicator
            const typingMessage = addTypingIndicator();

            try {
                // Try to send to Quest API
                const result = await sendToQuestAPI(userMessage);
                
                // Remove typing indicator
                typingMessage.remove();
                
                if (result.success) {
                    // API response was successful, message already added
                    console.log('AI Response:', result.response);
                    console.log('Sources:', result.sources);
                    console.log('Latency:', result.latency);
                }
            } catch (error) {
                console.error('Chat Error:', error);
                
                // Remove typing indicator
                typingMessage.remove();
                
                // Add error message
                addMessage(
                    "Sorry, I'm having trouble connecting to the AI service right now. " + 
                    "Please check your internet connection and try again.", 
                    false, 
                    true
                );
            }
            
            // Re-enable send button
            sendBtn.disabled = false;
            sendBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Send
            `;
        });

        // Auto-focus on input
        chatInput.focus();

        // Handle Enter key
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Initialize API health check
        checkApiHealth();

        // Add welcome message
        setTimeout(() => {
            addMessage("Try asking me about your saved articles, research topics, or any content you've collected! I'll use RAG to find relevant information from your knowledge base.", false);
        }, 2000);
    </script>
</body>
</html>
