<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS é—®é¢˜è¯Šæ–­ - Quest</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 1000px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .info { color: blue; }
        button { padding: 12px 24px; margin: 8px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 6px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .step { background: #e8f4fd; padding: 10px; margin: 8px 0; border-radius: 4px; }
        .cors-error { background: #ffe6e6; border-left: 4px solid #ff4444; }
        .network-error { background: #fff3cd; border-left: 4px solid #ffc107; }
        .success-result { background: #d4edda; border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <h1>ğŸ”’ CORS é—®é¢˜è¯Šæ–­å·¥å…·</h1>
    <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©ä½ è¯Šæ–­å’Œè§£å†³è·¨åŸŸè¯·æ±‚é—®é¢˜</p>
    
    <div class="test-section">
        <h2>ğŸ“‹ è¯Šæ–­æ­¥éª¤</h2>
        <div class="step">1. æµ‹è¯•åŸºç¡€è¿æ¥ - ç¡®è®¤ API æœåŠ¡å™¨å¯è®¿é—®</div>
        <div class="step">2. æµ‹è¯• CORS é¢„æ£€è¯·æ±‚ - æ£€æŸ¥è·¨åŸŸé…ç½®</div>
        <div class="step">3. æµ‹è¯•å®é™…è¯·æ±‚ - éªŒè¯å®Œæ•´æµç¨‹</div>
        <div class="step">4. åˆ†æç»“æœ - ç¡®å®šé—®é¢˜ç±»å‹</div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ” æ­¥éª¤ 1: åŸºç¡€è¿æ¥æµ‹è¯•</h2>
        <p>é¦–å…ˆç¡®è®¤ API æœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®ï¼ˆä¸æ¶‰åŠè·¨åŸŸï¼‰</p>
        <button onclick="testBasicConnection()">æµ‹è¯•åŸºç¡€è¿æ¥</button>
        <div id="basicResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸŒ æ­¥éª¤ 2: CORS é¢„æ£€è¯·æ±‚æµ‹è¯•</h2>
        <p>æµ‹è¯•æµè§ˆå™¨çš„é¢„æ£€è¯·æ±‚æ˜¯å¦æˆåŠŸ</p>
        <button onclick="testCORSPreflight()">æµ‹è¯• CORS é¢„æ£€</button>
        <div id="preflightResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“¤ æ­¥éª¤ 3: å®é™…è¯·æ±‚æµ‹è¯•</h2>
        <p>æµ‹è¯•å®é™…çš„ POST è¯·æ±‚</p>
        <button onclick="testActualRequest()">æµ‹è¯•å®é™…è¯·æ±‚</button>
        <div id="actualResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”§ æ­¥éª¤ 4: æ›¿ä»£æ–¹æ¡ˆæµ‹è¯•</h2>
        <p>æµ‹è¯•å…¶ä»–å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ</p>
        <button onclick="testAlternatives()">æµ‹è¯•æ›¿ä»£æ–¹æ¡ˆ</button>
        <div id="alternativesResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š è¯Šæ–­ç»“æœæ€»ç»“</h2>
        <div id="summaryResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'https://quest-api-edz1.onrender.com';
        const testResults = {};
        
        // æ­¥éª¤ 1: åŸºç¡€è¿æ¥æµ‹è¯•
        async function testBasicConnection() {
            const result = document.getElementById('basicResult');
            result.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                console.log('ğŸ” æµ‹è¯•åŸºç¡€è¿æ¥...');
                const response = await fetch(API_BASE);
                
                testResults.basic = {
                    success: true,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                const data = await response.text();
                console.log('âœ… åŸºç¡€è¿æ¥æˆåŠŸ:', testResults.basic);
                
                result.innerHTML = `
                    <div class="success-result">
                        <span class="success">âœ… åŸºç¡€è¿æ¥æˆåŠŸ!</span><br>
                        çŠ¶æ€: ${response.status} ${response.statusText}<br>
                        å“åº”: ${data}<br>
                        å“åº”å¤´: ${JSON.stringify(testResults.basic.headers, null, 2)}
                    </div>
                `;
                
            } catch (error) {
                testResults.basic = {
                    success: false,
                    error: error.message,
                    type: error.name
                };
                
                console.error('âŒ åŸºç¡€è¿æ¥å¤±è´¥:', error);
                result.innerHTML = `
                    <div class="cors-error">
                        <span class="error">âŒ åŸºç¡€è¿æ¥å¤±è´¥</span><br>
                        é”™è¯¯ç±»å‹: ${error.name}<br>
                        é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                        è¿™å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œä¸æ˜¯ CORS é—®é¢˜
                    </div>
                `;
            }
        }
        
        // æ­¥éª¤ 2: CORS é¢„æ£€è¯·æ±‚æµ‹è¯•
        async function testCORSPreflight() {
            const result = document.getElementById('preflightResult');
            result.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                console.log('ğŸŒ æµ‹è¯• CORS é¢„æ£€è¯·æ±‚...');
                
                // æµ‹è¯• OPTIONS è¯·æ±‚
                const optionsResponse = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });
                
                testResults.preflight = {
                    success: true,
                    status: optionsResponse.status,
                    statusText: optionsResponse.statusText,
                    headers: Object.fromEntries(optionsResponse.headers.entries())
                };
                
                console.log('âœ… CORS é¢„æ£€æˆåŠŸ:', testResults.preflight);
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': optionsResponse.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': optionsResponse.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': optionsResponse.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Max-Age': optionsResponse.headers.get('Access-Control-Max-Age')
                };
                
                result.innerHTML = `
                    <div class="success-result">
                        <span class="success">âœ… CORS é¢„æ£€è¯·æ±‚æˆåŠŸ!</span><br>
                        çŠ¶æ€: ${optionsResponse.status} ${optionsResponse.statusText}<br>
                        CORS å¤´: ${JSON.stringify(corsHeaders, null, 2)}<br>
                        å®Œæ•´å“åº”å¤´: ${JSON.stringify(testResults.preflight.headers, null, 2)}
                    </div>
                `;
                
            } catch (error) {
                testResults.preflight = {
                    success: false,
                    error: error.message,
                    type: error.name
                };
                
                console.error('âŒ CORS é¢„æ£€å¤±è´¥:', error);
                result.innerHTML = `
                    <div class="cors-error">
                        <span class="error">âŒ CORS é¢„æ£€è¯·æ±‚å¤±è´¥</span><br>
                        é”™è¯¯ç±»å‹: ${error.name}<br>
                        é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                        è¿™è¡¨æ˜å­˜åœ¨ CORS é…ç½®é—®é¢˜
                    </div>
                `;
            }
        }
        
        // æ­¥éª¤ 3: å®é™…è¯·æ±‚æµ‹è¯•
        async function testActualRequest() {
            const result = document.getElementById('actualResult');
            result.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                console.log('ğŸ“¤ æµ‹è¯•å®é™… POST è¯·æ±‚...');
                
                const response = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'cors-test@example.com',
                        nickname: 'corstest',
                        password: 'testpass123'
                    })
                });
                
                testResults.actual = {
                    success: true,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                console.log('âœ… å®é™…è¯·æ±‚æˆåŠŸ:', testResults.actual);
                
                const data = await response.text();
                result.innerHTML = `
                    <div class="success-result">
                        <span class="success">âœ… å®é™… POST è¯·æ±‚æˆåŠŸ!</span><br>
                        çŠ¶æ€: ${response.status} ${response.statusText}<br>
                        å“åº”: ${data}<br>
                        å“åº”å¤´: ${JSON.stringify(testResults.actual.headers, null, 2)}
                    </div>
                `;
                
            } catch (error) {
                testResults.actual = {
                    success: false,
                    error: error.message,
                    type: error.name
                };
                
                console.error('âŒ å®é™…è¯·æ±‚å¤±è´¥:', error);
                
                let errorType = 'æœªçŸ¥é”™è¯¯';
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorType = 'CORS é”™è¯¯ - è¯·æ±‚è¢«æµè§ˆå™¨é˜»æ­¢';
                } else if (error.name === 'TypeError' && error.message.includes('NetworkError')) {
                    errorType = 'ç½‘ç»œé”™è¯¯';
                }
                
                result.innerHTML = `
                    <div class="cors-error">
                        <span class="error">âŒ å®é™… POST è¯·æ±‚å¤±è´¥</span><br>
                        é”™è¯¯ç±»å‹: ${errorType}<br>
                        é”™è¯¯åç§°: ${error.name}<br>
                        é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                        è¿™é€šå¸¸æ˜¯ CORS é…ç½®é—®é¢˜
                    </div>
                `;
            }
        }
        
        // æ­¥éª¤ 4: æ›¿ä»£æ–¹æ¡ˆæµ‹è¯•
        async function testAlternatives() {
            const result = document.getElementById('alternativesResult');
            result.textContent = 'æµ‹è¯•ä¸­...';
            
            let alternatives = [];
            
            // æµ‹è¯• 1: ä¸åŒçš„ Content-Type
            try {
                const response1 = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: 'test data'
                });
                alternatives.push({
                    test: 'text/plain Content-Type',
                    success: true,
                    status: response1.status
                });
            } catch (error) {
                alternatives.push({
                    test: 'text/plain Content-Type',
                    success: false,
                    error: error.message
                });
            }
            
            // æµ‹è¯• 2: ä¸åŒçš„ç«¯ç‚¹
            try {
                const response2 = await fetch(`${API_BASE}/api/v1/metadata?url=https://example.com`);
                alternatives.push({
                    test: 'GET å…ƒæ•°æ®ç«¯ç‚¹',
                    success: true,
                    status: response2.status
                });
            } catch (error) {
                alternatives.push({
                    test: 'GET å…ƒæ•°æ®ç«¯ç‚¹',
                    success: false,
                    error: error.message
                });
            }
            
            // æµ‹è¯• 3: ä¸åŒçš„æ–¹æ³•
            try {
                const response3 = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'GET'
                });
                alternatives.push({
                    test: 'GET æ–¹æ³•',
                    success: true,
                    status: response3.status
                });
            } catch (error) {
                alternatives.push({
                    test: 'GET æ–¹æ³•',
                    success: false,
                    error: error.message
                });
            }
            
            testResults.alternatives = alternatives;
            
            let html = '<span class="info">â„¹ï¸ æ›¿ä»£æ–¹æ¡ˆæµ‹è¯•ç»“æœ:</span><br><br>';
            alternatives.forEach(alt => {
                if (alt.success) {
                    html += `<div class="success-result">âœ… ${alt.test}: æˆåŠŸ (${alt.status})</div>`;
                } else {
                    html += `<div class="cors-error">âŒ ${alt.test}: å¤±è´¥ - ${alt.error}</div>`;
                }
            });
            
            result.innerHTML = html;
        }
        
        // è‡ªåŠ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            console.log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰ CORS æµ‹è¯•...');
            
            await testBasicConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCORSPreflight();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testActualRequest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAlternatives();
            
            // ç”Ÿæˆæ€»ç»“
            generateSummary();
        }
        
        // ç”Ÿæˆè¯Šæ–­æ€»ç»“
        function generateSummary() {
            const result = document.getElementById('summaryResult');
            
            let summary = 'ğŸ“Š CORS è¯Šæ–­ç»“æœæ€»ç»“:\n\n';
            
            if (testResults.basic && testResults.basic.success) {
                summary += 'âœ… åŸºç¡€è¿æ¥: æ­£å¸¸\n';
            } else {
                summary += 'âŒ åŸºç¡€è¿æ¥: å¤±è´¥\n';
            }
            
            if (testResults.preflight && testResults.preflight.success) {
                summary += 'âœ… CORS é¢„æ£€: æ­£å¸¸\n';
            } else {
                summary += 'âŒ CORS é¢„æ£€: å¤±è´¥\n';
            }
            
            if (testResults.actual && testResults.actual.success) {
                summary += 'âœ… å®é™…è¯·æ±‚: æ­£å¸¸\n';
            } else {
                summary += 'âŒ å®é™…è¯·æ±‚: å¤±è´¥\n';
            }
            
            summary += '\nğŸ” é—®é¢˜åˆ†æ:\n';
            
            if (!testResults.basic || !testResults.basic.success) {
                summary += '- åŸºç¡€è¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨ä¸å¯è¾¾\n';
            } else if (!testResults.preflight || !testResults.preflight.success) {
                summary += '- CORS é¢„æ£€å¤±è´¥ï¼Œåç«¯æ²¡æœ‰æ­£ç¡®é…ç½® CORS å¤´\n';
            } else if (!testResults.actual || !testResults.actual.success) {
                summary += '- é¢„æ£€æˆåŠŸä½†å®é™…è¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æ˜¯ CORS é…ç½®ä¸å®Œæ•´\n';
            } else {
                summary += '- æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ŒCORS é…ç½®æ­£å¸¸\n';
            }
            
            summary += '\nğŸ”§ å»ºè®®è§£å†³æ–¹æ¡ˆ:\n';
            
            if (!testResults.preflight || !testResults.preflight.success) {
                summary += '1. åç«¯éœ€è¦æ·»åŠ  CORS ä¸­é—´ä»¶\n';
                summary += '2. é…ç½® Access-Control-Allow-Origin å¤´\n';
                summary += '3. é…ç½® Access-Control-Allow-Methods å¤´\n';
                summary += '4. é…ç½® Access-Control-Allow-Headers å¤´\n';
            }
            
            if (testResults.alternatives) {
                const workingAlternatives = testResults.alternatives.filter(alt => alt.success);
                if (workingAlternatives.length > 0) {
                    summary += '\nâœ… å¯ç”¨çš„æ›¿ä»£æ–¹æ¡ˆ:\n';
                    workingAlternatives.forEach(alt => {
                        summary += `- ${alt.test}\n`;
                    });
                }
            }
            
            result.textContent = summary;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>
