<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS 问题诊断 - Quest</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 1000px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .info { color: blue; }
        button { padding: 12px 24px; margin: 8px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 6px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .step { background: #e8f4fd; padding: 10px; margin: 8px 0; border-radius: 4px; }
        .cors-error { background: #ffe6e6; border-left: 4px solid #ff4444; }
        .network-error { background: #fff3cd; border-left: 4px solid #ffc107; }
        .success-result { background: #d4edda; border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <h1>🔒 CORS 问题诊断工具</h1>
    <p>这个工具将帮助你诊断和解决跨域请求问题</p>
    
    <div class="test-section">
        <h2>📋 诊断步骤</h2>
        <div class="step">1. 测试基础连接 - 确认 API 服务器可访问</div>
        <div class="step">2. 测试 CORS 预检请求 - 检查跨域配置</div>
        <div class="step">3. 测试实际请求 - 验证完整流程</div>
        <div class="step">4. 分析结果 - 确定问题类型</div>
    </div>
    
    <div class="test-section">
        <h2>🔍 步骤 1: 基础连接测试</h2>
        <p>首先确认 API 服务器是否可访问（不涉及跨域）</p>
        <button onclick="testBasicConnection()">测试基础连接</button>
        <div id="basicResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>🌐 步骤 2: CORS 预检请求测试</h2>
        <p>测试浏览器的预检请求是否成功</p>
        <button onclick="testCORSPreflight()">测试 CORS 预检</button>
        <div id="preflightResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>📤 步骤 3: 实际请求测试</h2>
        <p>测试实际的 POST 请求</p>
        <button onclick="testActualRequest()">测试实际请求</button>
        <div id="actualResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>🔧 步骤 4: 替代方案测试</h2>
        <p>测试其他可能的解决方案</p>
        <button onclick="testAlternatives()">测试替代方案</button>
        <div id="alternativesResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>📊 诊断结果总结</h2>
        <div id="summaryResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'https://quest-api-edz1.onrender.com';
        const testResults = {};
        
        // 步骤 1: 基础连接测试
        async function testBasicConnection() {
            const result = document.getElementById('basicResult');
            result.textContent = '测试中...';
            
            try {
                console.log('🔍 测试基础连接...');
                const response = await fetch(API_BASE);
                
                testResults.basic = {
                    success: true,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                const data = await response.text();
                console.log('✅ 基础连接成功:', testResults.basic);
                
                result.innerHTML = `
                    <div class="success-result">
                        <span class="success">✅ 基础连接成功!</span><br>
                        状态: ${response.status} ${response.statusText}<br>
                        响应: ${data}<br>
                        响应头: ${JSON.stringify(testResults.basic.headers, null, 2)}
                    </div>
                `;
                
            } catch (error) {
                testResults.basic = {
                    success: false,
                    error: error.message,
                    type: error.name
                };
                
                console.error('❌ 基础连接失败:', error);
                result.innerHTML = `
                    <div class="cors-error">
                        <span class="error">❌ 基础连接失败</span><br>
                        错误类型: ${error.name}<br>
                        错误信息: ${error.message}<br>
                        这可能是网络问题，不是 CORS 问题
                    </div>
                `;
            }
        }
        
        // 步骤 2: CORS 预检请求测试
        async function testCORSPreflight() {
            const result = document.getElementById('preflightResult');
            result.textContent = '测试中...';
            
            try {
                console.log('🌐 测试 CORS 预检请求...');
                
                // 测试 OPTIONS 请求
                const optionsResponse = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });
                
                testResults.preflight = {
                    success: true,
                    status: optionsResponse.status,
                    statusText: optionsResponse.statusText,
                    headers: Object.fromEntries(optionsResponse.headers.entries())
                };
                
                console.log('✅ CORS 预检成功:', testResults.preflight);
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': optionsResponse.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': optionsResponse.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': optionsResponse.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Max-Age': optionsResponse.headers.get('Access-Control-Max-Age')
                };
                
                result.innerHTML = `
                    <div class="success-result">
                        <span class="success">✅ CORS 预检请求成功!</span><br>
                        状态: ${optionsResponse.status} ${optionsResponse.statusText}<br>
                        CORS 头: ${JSON.stringify(corsHeaders, null, 2)}<br>
                        完整响应头: ${JSON.stringify(testResults.preflight.headers, null, 2)}
                    </div>
                `;
                
            } catch (error) {
                testResults.preflight = {
                    success: false,
                    error: error.message,
                    type: error.name
                };
                
                console.error('❌ CORS 预检失败:', error);
                result.innerHTML = `
                    <div class="cors-error">
                        <span class="error">❌ CORS 预检请求失败</span><br>
                        错误类型: ${error.name}<br>
                        错误信息: ${error.message}<br>
                        这表明存在 CORS 配置问题
                    </div>
                `;
            }
        }
        
        // 步骤 3: 实际请求测试
        async function testActualRequest() {
            const result = document.getElementById('actualResult');
            result.textContent = '测试中...';
            
            try {
                console.log('📤 测试实际 POST 请求...');
                
                const response = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'cors-test@example.com',
                        nickname: 'corstest',
                        password: 'testpass123'
                    })
                });
                
                testResults.actual = {
                    success: true,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                console.log('✅ 实际请求成功:', testResults.actual);
                
                const data = await response.text();
                result.innerHTML = `
                    <div class="success-result">
                        <span class="success">✅ 实际 POST 请求成功!</span><br>
                        状态: ${response.status} ${response.statusText}<br>
                        响应: ${data}<br>
                        响应头: ${JSON.stringify(testResults.actual.headers, null, 2)}
                    </div>
                `;
                
            } catch (error) {
                testResults.actual = {
                    success: false,
                    error: error.message,
                    type: error.name
                };
                
                console.error('❌ 实际请求失败:', error);
                
                let errorType = '未知错误';
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorType = 'CORS 错误 - 请求被浏览器阻止';
                } else if (error.name === 'TypeError' && error.message.includes('NetworkError')) {
                    errorType = '网络错误';
                }
                
                result.innerHTML = `
                    <div class="cors-error">
                        <span class="error">❌ 实际 POST 请求失败</span><br>
                        错误类型: ${errorType}<br>
                        错误名称: ${error.name}<br>
                        错误信息: ${error.message}<br>
                        这通常是 CORS 配置问题
                    </div>
                `;
            }
        }
        
        // 步骤 4: 替代方案测试
        async function testAlternatives() {
            const result = document.getElementById('alternativesResult');
            result.textContent = '测试中...';
            
            let alternatives = [];
            
            // 测试 1: 不同的 Content-Type
            try {
                const response1 = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: 'test data'
                });
                alternatives.push({
                    test: 'text/plain Content-Type',
                    success: true,
                    status: response1.status
                });
            } catch (error) {
                alternatives.push({
                    test: 'text/plain Content-Type',
                    success: false,
                    error: error.message
                });
            }
            
            // 测试 2: 不同的端点
            try {
                const response2 = await fetch(`${API_BASE}/api/v1/metadata?url=https://example.com`);
                alternatives.push({
                    test: 'GET 元数据端点',
                    success: true,
                    status: response2.status
                });
            } catch (error) {
                alternatives.push({
                    test: 'GET 元数据端点',
                    success: false,
                    error: error.message
                });
            }
            
            // 测试 3: 不同的方法
            try {
                const response3 = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'GET'
                });
                alternatives.push({
                    test: 'GET 方法',
                    success: true,
                    status: response3.status
                });
            } catch (error) {
                alternatives.push({
                    test: 'GET 方法',
                    success: false,
                    error: error.message
                });
            }
            
            testResults.alternatives = alternatives;
            
            let html = '<span class="info">ℹ️ 替代方案测试结果:</span><br><br>';
            alternatives.forEach(alt => {
                if (alt.success) {
                    html += `<div class="success-result">✅ ${alt.test}: 成功 (${alt.status})</div>`;
                } else {
                    html += `<div class="cors-error">❌ ${alt.test}: 失败 - ${alt.error}</div>`;
                }
            });
            
            result.innerHTML = html;
        }
        
        // 自动运行所有测试
        async function runAllTests() {
            console.log('🚀 开始运行所有 CORS 测试...');
            
            await testBasicConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCORSPreflight();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testActualRequest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAlternatives();
            
            // 生成总结
            generateSummary();
        }
        
        // 生成诊断总结
        function generateSummary() {
            const result = document.getElementById('summaryResult');
            
            let summary = '📊 CORS 诊断结果总结:\n\n';
            
            if (testResults.basic && testResults.basic.success) {
                summary += '✅ 基础连接: 正常\n';
            } else {
                summary += '❌ 基础连接: 失败\n';
            }
            
            if (testResults.preflight && testResults.preflight.success) {
                summary += '✅ CORS 预检: 正常\n';
            } else {
                summary += '❌ CORS 预检: 失败\n';
            }
            
            if (testResults.actual && testResults.actual.success) {
                summary += '✅ 实际请求: 正常\n';
            } else {
                summary += '❌ 实际请求: 失败\n';
            }
            
            summary += '\n🔍 问题分析:\n';
            
            if (!testResults.basic || !testResults.basic.success) {
                summary += '- 基础连接失败，可能是网络问题或服务器不可达\n';
            } else if (!testResults.preflight || !testResults.preflight.success) {
                summary += '- CORS 预检失败，后端没有正确配置 CORS 头\n';
            } else if (!testResults.actual || !testResults.actual.success) {
                summary += '- 预检成功但实际请求失败，可能是 CORS 配置不完整\n';
            } else {
                summary += '- 所有测试通过，CORS 配置正常\n';
            }
            
            summary += '\n🔧 建议解决方案:\n';
            
            if (!testResults.preflight || !testResults.preflight.success) {
                summary += '1. 后端需要添加 CORS 中间件\n';
                summary += '2. 配置 Access-Control-Allow-Origin 头\n';
                summary += '3. 配置 Access-Control-Allow-Methods 头\n';
                summary += '4. 配置 Access-Control-Allow-Headers 头\n';
            }
            
            if (testResults.alternatives) {
                const workingAlternatives = testResults.alternatives.filter(alt => alt.success);
                if (workingAlternatives.length > 0) {
                    summary += '\n✅ 可用的替代方案:\n';
                    workingAlternatives.forEach(alt => {
                        summary += `- ${alt.test}\n`;
                    });
                }
            }
            
            result.textContent = summary;
        }
        
        // 页面加载完成后自动运行测试
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>
